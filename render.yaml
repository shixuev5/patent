services:
  - type: web
    name: patent-backend
    env: python
    plan: starter
    buildCommand: |
      pip install --upgrade pip uv
      uv sync --frozen --no-dev
      uv run playwright install chromium
    startCommand: uv run --no-sync uvicorn api:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /api/health
    autoDeploy: true
    disk:
      name: patent-storage
      mountPath: /var/data
      sizeGB: 20
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.11
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: APP_STORAGE_ROOT
        value: /var/data/patent
      - key: TASK_STORAGE_BACKEND
        value: d1
      - key: D1_ACCOUNT_ID
        sync: false
      - key: D1_DATABASE_ID
        sync: false
      - key: D1_API_TOKEN
        sync: false
      - key: D1_API_BASE_URL
        value: https://api.cloudflare.com/client/v4
      - key: MINERU_MODEL_SOURCE
        value: modelscope
      - key: MINERU_API_KEY
        sync: false
      - key: MINERU_BASE_URL
        value: https://mineru.net/api/v4
      - key: PDF_PARSER
        value: local
      - key: OCR_API_KEY
        sync: false
      - key: OCR_BASE_URL
        value: https://j9dd7babo5tcocz9.aistudio-app.com/ocr
      - key: OCR_ENGINE
        value: local
      - key: LLM_API_KEY
        sync: false
      - key: LLM_BASE_URL
        value: https://api.deepseek.com
      - key: LLM_MODEL
        value: deepseek-chat
      - key: LLM_MODEL_REASONING
        value: deepseek-reasoner
      - key: LLM_EXAM_API_KEY
        sync: false
      - key: LLM_EXAM_BASE_URL
        value: https://api.siliconflow.cn/v1
      - key: LLM_MODEL_EXAM
        value: deepseek-chat
      - key: VLM_API_KEY
        sync: false
      - key: VLM_BASE_URL
        value: https://open.bigmodel.cn/api/paas/v4
      - key: VLM_MODEL
        value: glm-4.6v
      - key: ZHIHUIYA_USERNAME
        sync: false
      - key: ZHIHUIYA_PASSWORD
        sync: false
      - key: R2_ENABLED
        value: "false"
      - key: R2_ENDPOINT_URL
        sync: false
      - key: R2_ACCESS_KEY_ID
        sync: false
      - key: R2_SECRET_ACCESS_KEY
        sync: false
      - key: R2_BUCKET
        sync: false
      - key: R2_REGION
        value: auto
      - key: R2_KEY_PREFIX
        value: patent
      - key: AUTH_SECRET
        sync: false
      - key: AUTH_TOKEN_TTL_DAYS
        value: "30"
      - key: MAX_DAILY_ANALYSIS
        value: "3"
      - key: APP_TZ_OFFSET_HOURS
        value: "8"
